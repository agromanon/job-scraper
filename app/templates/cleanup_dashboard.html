{% extends "base.html" %}

{% block title %}Database Cleanup - Job Scraper Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">Database Cleanup</h1>
                <p class="text-muted mb-0">Manage and monitor database cleanup operations</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('run_cleanup') }}" class="btn btn-primary">
                    <i class="bi bi-play-circle me-1"></i>Run Cleanup Now
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Statistics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="metric-card-title">Total Jobs</h6>
                        <div class="metric-card-value">{{ "{:,}".format(stats.get('total_jobs', 0) | int) if stats.get('total_jobs') is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-journal-text text-primary fs-4"></i>
                    </div>
                </div>
            </div>
            <div class="metric-card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Total jobs in database
                </small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="metric-card-title">Inactive Jobs</h6>
                        <div class="metric-card-value">{{ "{:,}".format(stats.get('inactive_jobs', 0) | int) if stats.get('inactive_jobs') is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
                    </div>
                </div>
            </div>
            <div class="metric-card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Jobs marked as inactive
                </small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="metric-card-title">Old Inactive Jobs</h6>
                        <div class="metric-card-value">{{ "{:,}".format(stats.get('old_inactive_jobs', 0) | int) if stats.get('old_inactive_jobs') is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-trash text-danger fs-4"></i>
                    </div>
                </div>
            </div>
            <div class="metric-card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Inactive for 30+ days
                </small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="metric-card-title">Last Job</h6>
                        <div class="metric-card-value">
                            {% if stats.get('most_recent_job') %}
                                {{ stats.get('most_recent_job').strftime('%Y-%m-%d') if stats.get('most_recent_job') else 'N/A' }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-clock-history text-info fs-4"></i>
                    </div>
                </div>
            </div>
            <div class="metric-card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Most recent job date
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Recent Cleanup Runs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Cleanup Runs</h5>
            </div>
            <div class="card-body">
                {% if recent_cleanups %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Jobs Processed</th>
                                    <th>Jobs Removed</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cleanup in recent_cleanups %}
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>{{ cleanup.get('execution_start', '').strftime('%Y-%m-%d %H:%M') if cleanup.get('execution_start') else 'N/A' }}</strong>
                                                <small class="text-muted d-block">{{ cleanup.get('worker_name', 'N/A') }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if cleanup.get('status') == 'success' else 'danger' }}">
                                                {{ cleanup.get('status', 'N/A') }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="fw-bold">{{ cleanup.get('duration_seconds', 0) }}s</span>
                                        </td>
                                        <td>
                                            <span class="fw-bold">{{ "{:,}".format(cleanup.get('jobs_found', 0) | int) }}</span>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-danger">-{{ "{:,}".format(cleanup.get('jobs_inserted', 0) | int) }}</span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-trash text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No Cleanup Runs Yet</h5>
                        <p class="text-muted">Run a cleanup to start removing inactive jobs</p>
                        <a href="{{ url_for('run_cleanup') }}" class="btn btn-primary">
                            <i class="bi bi-play-circle me-1"></i>Run First Cleanup
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Database Cleanup Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <h6><i class="bi bi-info-circle me-2 text-primary"></i>About Cleanup</h6>
                        <p class="text-muted">
                            The database cleanup process removes inactive job listings that have not been seen 
                            in the last 30 days. This helps maintain database performance and reduces storage usage.
                        </p>
                        <ul class="text-muted">
                            <li>Runs automatically every 24 hours</li>
                            <li>Removes jobs marked as inactive for 30+ days</li>
                            <li>Maintains database performance and storage efficiency</li>
                            <li>Can be run manually at any time</li>
                        </ul>
                    </div>
                    <div class="col-lg-6">
                        <h6><i class="bi bi-lightning-charge me-2 text-warning"></i>Manual Cleanup</h6>
                        <p class="text-muted">
                            You can manually trigger a cleanup at any time. This is useful after importing 
                            large datasets or when you want to immediately reclaim storage space.
                        </p>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('run_cleanup') }}" class="btn btn-primary">
                                <i class="bi bi-play-circle me-1"></i>Run Manual Cleanup
                            </a>
                            <small class="text-muted text-center">
                                Estimated cleanup time: 5-15 minutes depending on database size
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}